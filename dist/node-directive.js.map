{"version":3,"sources":["../src/node-directive.js"],"names":["angular","_","kbn","$","module","directive","$compile","linkSrv","linkTemplate","createMenuTemplate","ctrl","template","dashboard","meta","canEdit","fullscreen","each","getMenu","item","role","click","href","text","getExtendedMenu","restrict","link","$scope","elem","$link","$panelLinksBtn","find","$panelContainer","parents","menuScope","timeout","$menu","teather","append","$watchCollection","newValue","showIcon","length","panel","title","toggle","dismiss","time","force","clearTimeout","setTimeout","is","$$panelDragging","destroy","unbind","remove","$destroy","removeClass","showMenu","e","contains","document","target","menuTemplate","hasClass","createExternalLinkMenu","mouseleave","$new","extendedMenu","toggleClass","$apply","contents","Tether","element","attachment","targetAttachment","constraints","to","pin"],"mappings":"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","file":"node-directive.js","sourcesContent":["import angular from 'angular';\r\nimport _ from  'lodash';\r\nimport kbn from 'app/core/utils/kbn';\r\nimport $ from 'jquery';\r\n\r\n  angular\r\n    .module('grafana.directives')\r\n    .directive('nodeMenu', function($compile, linkSrv) {\r\n      var linkTemplate ='hello'\r\n        /*  '<span class=\"panel-title drag-handle pointer\">' +\r\n            '<span class=\"panel-title-text drag-handle\">{{ctrl.panel.chartDataModel.nodes.name | interpolateTemplateVars:this}}</span>' +\r\n            '<span class=\"panel-links-btn\"><i class=\"fa fa-external-link\"></i></span>' +\r\n            '<span class=\"panel-time-info\" ng-show=\"ctrl.timeInfo\"><i class=\"fa fa-clock-o\"></i> {{ctrl.timeInfo}}</span>' +\r\n          '</span>';\r\n\r\n      function createExternalLinkMenu(ctrl) {\r\n        var template = '<div class=\"node-menu small\">';\r\n        template += '<div class=\"node-menu-row\">';\r\n\r\n        if (ctrl.panel.links) {\r\n          _.each(ctrl.panel.links, function(link) {\r\n            var info = linkSrv.getPanelLinkAnchorInfo(link, ctrl.panel.scopedVars);\r\n            template += '<a class=\"panel-menu-link\" href=\"' + info.href + '\" target=\"' + info.target + '\">' + info.title + '</a>';\r\n          });\r\n        }\r\n        return template;\r\n      }\r\n*/\r\n      function createMenuTemplate(ctrl) {\r\n        var template = '<div class=\"panel-menu small\" style=\"margin-top: -130px;\">';\r\n\r\n        if (ctrl.dashboard.meta.canEdit) {\r\n          template += '<div class=\"panel-menu-inner\">';\r\n          template += '<div class=\"panel-menu-row\">';\r\n          if (!ctrl.dashboard.meta.fullscreen) {\r\n            //template += '<a class=\"panel-menu-icon pull-left\" ng-click=\"ctrl.updateColumnSpan(-1)\"><i class=\"fa fa-minus\"></i></a>';\r\n            //template += '<a class=\"panel-menu-icon pull-left\" ng-click=\"ctrl.updateColumnSpan(1)\"><i class=\"fa fa-plus\"></i></a>';\r\n          }\r\n          template += '<a class=\"panel-menu-icon pull-right\" ng-click=\"ctrl.removeNode(ctrl.panel.chartDataModel.nodes)\"><i class=\"fa fa-trash\"></i></a>';\r\n         template += '<div class=\"clearfix\"></div>';\r\n          template += '</div>';\r\n        }\r\n\r\n        template += '<div class=\"panel-menu-row\">';\r\n        template += '<a class=\"panel-menu-link\" gf-dropdown=\"extendedMenu\"><i class=\"fa fa-bars\"></i></a>';\r\n\r\n        _.each(ctrl.getMenu(), function(item) {\r\n          // skip edit actions if not editor\r\n          if (item.role === 'Editor' && !ctrl.dashboard.meta.canEdit) {\r\n            return;\r\n          }\r\n\r\n          template += '<a class=\"panel-menu-link\" ';\r\n          if (item.click) { template += ' ng-click=\"' + item.click + '\"'; }\r\n          if (item.href) { template += ' href=\"' + item.href + '\"'; }\r\n          template += '>';\r\n          template += item.text + '</a>';\r\n        });\r\n\r\n        template += '</div>';\r\n        template += '</div>';\r\n        template += '</div>';\r\n        return template;\r\n      }\r\n\r\n      function getExtendedMenu(ctrl) {\r\n        return ctrl.getExtendedMenu();\r\n      }\r\n\r\n      return {\r\n        restrict: 'A',\r\n        link: function($scope, elem) {\r\n          var $link = $(linkTemplate);\r\n          var $panelLinksBtn = $link.find(\".panel-links-btn\");\r\n          var $panelContainer = elem.parents(\".panel-container\");\r\n          var menuScope = null;\r\n          var ctrl = $scope.ctrl;\r\n          var timeout = null;\r\n          var $menu = null;\r\n          var teather;\r\n\r\n          elem.append($link);\r\n\r\n          $scope.$watchCollection('ctrl.panel.links', function(newValue) {\r\n            var showIcon = (newValue ? newValue.length > 0 : false) && ctrl.panel.title !== '';\r\n            $panelLinksBtn.toggle(showIcon);\r\n          });\r\n\r\n          function dismiss(time, force) {\r\n            clearTimeout(timeout);\r\n            timeout = null;\r\n\r\n            if (time) {\r\n              timeout = setTimeout(dismiss, time);\r\n              return;\r\n            }\r\n\r\n            // if hovering or draging pospone close\r\n            if (force !== true) {\r\n              if ($menu.is(':hover') || $scope.ctrl.dashboard.$$panelDragging) {\r\n                dismiss(2200);\r\n                return;\r\n              }\r\n            }\r\n\r\n            if (menuScope) {\r\n              teather.destroy();\r\n              $menu.unbind();\r\n              $menu.remove();\r\n              menuScope.$destroy();\r\n              menuScope = null;\r\n              $menu = null;\r\n              $panelContainer.removeClass('panel-highlight');\r\n            }\r\n          }\r\n\r\n          var showMenu = function(e) {\r\n            // if menu item is clicked and menu was just removed from dom ignore this event\r\n            if (!$.contains(document, e.target)) {\r\n              return;\r\n            }\r\n\r\n            if ($menu) {\r\n              dismiss();\r\n              return;\r\n            }\r\n\r\n            var menuTemplate;\r\n            if ($(e.target).hasClass('fa-external-link')) {\r\n              menuTemplate = createExternalLinkMenu(ctrl);\r\n            } else {\r\n              menuTemplate = createMenuTemplate(ctrl);\r\n            }\r\n\r\n            $menu = $(menuTemplate);\r\n            $menu.mouseleave(function() {\r\n              dismiss(1000);\r\n            });\r\n\r\n            menuScope = $scope.$new();\r\n            menuScope.extendedMenu = getExtendedMenu(ctrl);\r\n            menuScope.dismiss = function() {\r\n              dismiss(null, true);\r\n            };\r\n\r\n            $(\".panel-container\").removeClass('panel-highlight');\r\n            $panelContainer.toggleClass('panel-highlight');\r\n\r\n            $('.panel-menu').remove();\r\n\r\n            elem.append($menu);\r\n\r\n            $scope.$apply(function() {\r\n              $compile($menu.contents())(menuScope);\r\n\r\n              teather = new Tether({\r\n                element: $menu,\r\n                target: $panelContainer,\r\n                attachment: 'bottom center',\r\n                targetAttachment: 'top center',\r\n                constraints: [\r\n                  {\r\n                    to: 'window',\r\n                    attachment: 'together',\r\n                    pin: true\r\n                  }\r\n                ]\r\n              });\r\n            });\r\n\r\n            dismiss(2200);\r\n          };\r\n\r\n          elem.click(showMenu);\r\n          $compile(elem.contents())($scope);\r\n        }\r\n      };\r\n    });\r\n\r\n"]}